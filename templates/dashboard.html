{% extends "base.html" %}
{% block content %}
    <h1 class="page-title">{{ _('Listem') }}</h1>
    
    <!-- Üst sıra: Import ve Toplu İşlemler -->
    <div class="page-controls">
        <div class="actions-group">
            <button id="import-mal-btn" class="btn btn-secondary" style="font-size: 0.9rem; padding: 0.5rem 1rem;">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="14" height="14" style="margin-right: 6px;">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                </svg>
                {{ _('MAL Import') }}
            </button>
            <button id="select-all-btn" class="btn btn-secondary" style="font-size: 0.9rem; padding: 0.5rem 1rem;">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="14" height="14" style="margin-right: 6px;">
                    <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
                </svg>
                {{ _('Tümünü Seç') }}
            </button>
            <button id="bulk-delete-btn" class="btn btn-danger" style="font-size: 0.9rem; padding: 0.5rem 1rem; display: none;">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="14" height="14" style="margin-right: 6px;">
                    <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                </svg>
                {{ _('Seçilenleri Sil') }}
            </button>
        </div>
        <div id="my-list-status-container" class="segmented-group">
            <button class="filter-btn active" data-status="all">{{ _('Tümü') }}</button>
            <button class="filter-btn" data-status="İzleniyor">{{ _('İzleniyor') }}</button>
            <button class="filter-btn" data-status="Okunuyor">{{ _('Okunuyor') }}</button>
            <button class="filter-btn" data-status="Tamamlandı">{{ _('Tamamlandı') }}</button>
            <button class="filter-btn" data-status="Planlandı">{{ _('Planlandı') }}</button>
            <button class="filter-btn" data-status="Bırakıldı">{{ _('Bırakıldı') }}</button>
        </div>
    </div>
    
    <!-- Üst sıra: Durum filtreleri -->
    <div class="page-controls">
        <div id="my-list-status-container" class="segmented-group">
            <button class="filter-btn active" data-status="all">{{ _('Tümü') }}</button>
            <button class="filter-btn" data-status="İzleniyor">{{ _('İzleniyor') }}</button>
            <button class="filter-btn" data-status="Okunuyor">{{ _('Okunuyor') }}</button>
            <button class="filter-btn" data-status="Tamamlandı">{{ _('Tamamlandı') }}</button>
            <button class="filter-btn" data-status="Planlandı">{{ _('Planlandı') }}</button>
            <button class="filter-btn" data-status="Bırakıldı">{{ _('Bırakıldı') }}</button>
        </div>
    </div>
    <!-- Alt sıra: Arama ve ileri filtreler -->
    <div class="page-controls">
        <div id="my-list-search-container" class="search-container">
            <div class="search-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="20" height="20"><path fill-rule="evenodd" d="M10.5 3.75a6.75 6.75 0 100 13.5 6.75 6.75 0 000-13.5zM2.25 10.5a8.25 8.25 0 1114.59 5.28l4.69 4.69a.75.75 0 11-1.06 1.06l-4.69-4.69A8.25 8.25 0 012.25 10.5z" clip-rule="evenodd" /></svg></div>
            <input type="text" id="my-list-search-box" class="search-box" placeholder="{{ _('Listemde ara...') }}" autocomplete="off">
            <button id="my-list-clear-btn" class="search-clear-btn hidden" aria-label="{{ _('Temizle') }}">&times;</button>
        </div>
        <div id="my-list-filters" class="filters-group">
            <select id="my-list-sort-by" class="filter-btn filter-select">
                <option value="default">{{ _('Sıralama Yok') }}</option>
                <option value="title-asc">{{ _('Başlık (A-Z)') }}</option>
                <option value="title-desc">{{ _('Başlık (Z-A)') }}</option>
                <option value="score-desc">{{ _('Puanım (Yüksekten Düşüğe)') }}</option>
                <option value="score-asc">{{ _('Puanım (Düşükten Yükseğe)') }}</option>
                <option value="year-desc">{{ _('Yıl (Yeniden Eskiye)') }}</option>
                <option value="year-asc">{{ _('Yıl (Eskiden Yeniye)') }}</option>
            </select>
            <select id="my-list-year-filter" class="filter-btn filter-select">
                <option value="">{{ _('Tüm Yıllar') }}</option>
                {% for y in years %}<option value="{{ y }}">{{ y }}</option>{% endfor %}
            </select>
            <select id="my-list-studio-filter" class="filter-btn filter-select">
                <option value="">{{ _('Tüm Stüdyolar') }}</option>
                {% for studio in studios %}<option value="{{ studio }}">{{ studio }}</option>{% endfor %}
            </select>
            <div id="my-list-tag-multiselect" class="tag-multiselect">
                <button type="button" class="filter-btn tag-toggle" id="my-list-tag-toggle">{{ _('Filtreler') }}</button>
                <div class="tag-panel" id="my-list-tag-panel">
                    <div class="tag-list">
                        <strong style="grid-column: 1 / -1; color: var(--text-primary);">{{ _('Genre') }}</strong>
                        {% for tag in tags %}<label class="tag-item"><input type="checkbox" data-kind="genre" value="{{ tag }}"><span>{{ tag }}</span></label>{% endfor %}
                        <strong style="grid-column: 1 / -1; margin-top: .5rem; color: var(--text-primary);">{{ _('Theme') }}</strong>
                        {% for theme in themes %}<label class="tag-item"><input type="checkbox" data-kind="theme" value="{{ theme }}"><span>{{ theme }}</span></label>{% endfor %}
                        <strong style="grid-column: 1 / -1; margin-top: .5rem; color: var(--text-primary);">{{ _('Demografi') }}</strong>
                        {% for demo in demographics %}<label class="tag-item"><input type="checkbox" data-kind="demographic" value="{{ demo }}"><span>{{ demo }}</span></label>{% endfor %}
                    </div>
                    <div class="tag-actions">
                        <button type="button" class="btn btn-secondary" id="my-list-clear-tags">{{ _('Temizle') }}</button>
                        <button type="button" class="btn btn-primary" id="my-list-apply-tags">{{ _('Uygula') }}</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="my-list-selected-bar" class="selected-bar"></div>
    <div id="results-container">
        {% for item in user_list %}
            <div class="manhwa-card" 
                data-user-list-id="{{ item.list_item.id }}" 
                data-user-score="{{ item.list_item.user_score or 0 }}"
                data-status="{{ item.list_item.status }}" 
                data-chapter="{{ item.list_item.current_chapter }}" 
                data-notes="{{ item.list_item.notes or '' }}" 
                data-record-title="{{ item.record.original_title }}"
                data-record-english-title="{{ item.record.english_title or '' }}"
                data-record-image="{{ item.record.image_url or '' }}" 
                data-record-type="{{ item.record.record_type }}" 
                data-synopsis="{{ item.record.synopsis or '' }}"
                data-tags="{{ item.record.tags or '' }}"
                data-themes="{{ item.record.themes or '' }}"
                data-demographics="{{ item.record.demographics or '' }}"
                data-source="{{ item.record.source or '' }}"
                data-studios="{{ item.record.studios or '' }}"
                data-release-year="{{ item.record.release_year or 0 }}"
                data-total-episodes="{{ item.record.total_episodes or '' }}">
                <div class="card-checkbox">
                    <input type="checkbox" class="card-select-checkbox" data-user-list-id="{{ item.list_item.id }}">
                </div>
                <div class="card-image-wrapper"><img src="{{ item.record.image_url or 'https://via.placeholder.com/250x350.png?text=Yok' }}" class="card-image" loading="lazy"></div>
                <div class="card-info">
                    <h3 class="card-title">{{ item.record.original_title }}</h3>
                    <div class="card-bottom-info">
                        <span>{{ _('Bölüm:') }} {{ item.list_item.current_chapter }}{% if item.record.total_episodes %} / {{ item.record.total_episodes }}{% endif %}</span>
                        <button class="inc-chapter-btn" title="{{ _('Bir bölüm arttır') }}">+1</button>
                        {% if item.list_item.user_score > 0 %}
                        <span class="user-score">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path fill-rule="evenodd" d="M10.788 3.21c.448-1.077 1.976-1.077 2.424 0l2.082 5.007 5.404.433c1.164.093 1.636 1.545.749 2.305l-4.117 3.527 1.257 5.273c.271 1.136-.964 2.033-1.96 1.425L12 18.354 7.373 21.18c-.996.608-2.231-.29-1.96-1.425l1.257-5.273-4.117-3.527c-.887-.76-.415-2.212.749-2.305l5.404-.433 2.082-5.007z" clip-rule="evenodd" /></svg>
                            {{ item.list_item.user_score }}
                        </span>
                        {% endif %}
                    </div>
                    {% if item.record.total_episodes %}
                        {% set pct = (item.list_item.current_chapter * 100 / (item.record.total_episodes if item.record.total_episodes else 1)) | round(0, 'floor') %}
                        <div class="progress-bar" title="{{ pct }}%"><div class="progress" data-pct="{{ pct }}"></div></div>
                    {% endif %}
                </div>
            </div>
        {% else %}
            <p style="color: var(--text-secondary); grid-column: 1 / -1; text-align: center;">{{ _('Listen henüz boş. Arama yaparak yeni kayıtlar ekleyebilirsin!') }}</p>
        {% endfor %}
    </div>
    <!-- GÜNCELLEME/DETAY MODALI (Değişiklik yok) -->
    <div id="update-item-modal" class="modal">
        <div class="modal-content details-modal-content">
            <span id="close-update-modal-btn" class="close-btn">&times;</span>
            <div class="details-layout">
                <div class="details-top-section">
                    <img id="details-image" src="" alt="Kapak Fotoğrafı" class="details-image">
                    <div class="details-form-container">
                        <h2 id="update-modal-title"></h2>
                        <form id="update-item-form" class="details-form">
                            <input type="hidden" id="user-list-id-input">
                            <div class="form-content">
                                <div class="admin-form-grid">
                                    <div class="form-group"><label for="status-input">{{ _('Durum:') }}</label><select id="status-input" name="status"><option value="İzleniyor">{{ _('İzleniyor') }}</option><option value="Okunuyor">{{ _('Okunuyor') }}</option><option value="Tamamlandı">{{ _('Tamamlandı') }}</option><option value="Planlandı">{{ _('Planlandı') }}</option><option value="Bırakıldı">{{ _('Bırakıldı') }}</option></select></div>
                                    <div class="form-group"><label for="user-score-input">{{ _('Puanım:') }}</label><div class="score-input-container"><select id="user-score-input" name="user_score"><option value="0">({{ _('Puan Yok') }})</option><option value="10">(10) Masterpiece</option><option value="9">(9) Great</option><option value="8">(8) Very Good</option><option value="7">(7) Good</option><option value="6">(6) Fine</option><option value="5">(5) Average</option><option value="4">(4) Bad</option><option value="3">(3) Very Bad</option><option value="2">(2) Horrible</option><option value="1">(1) Appalling</option></select></div></div>
                                </div>
                                <div class="form-group"><label for="chapter-input">{{ _('İzlenen/Okunan Bölüm:') }}</label><input type="number" id="chapter-input" name="chapter" min="0"></div>
                                <div class="form-group"><label for="notes-input">{{ _('Kişisel Notlar:') }}</label><textarea id="notes-input" name="notes" rows="3"></textarea></div>
                            </div>
                            <div class="modal-actions">
                                 <button type="button" id="delete-item-btn" class="btn btn-danger">{{ _('Listeden Sil') }}</button>
                                 <button type="submit" class="btn btn-primary">{{ _('Değişiklikleri Kaydet') }}</button>
                            </div>
                        </form>
                    </div>
                </div>
                <div class="details-bottom-section">
                    <div class="info-item"><span class="info-label">{{ _('Yayın Yılı:') }}</span> <span id="details-release-year"></span></div>
                    <div class="info-item"><span class="info-label">{{ _('Kaynak:') }}</span> <span id="details-source"></span></div>
                    <div class="info-item"><span class="info-label">{{ _('Stüdyo:') }}</span> <span id="details-studios"></span></div>
                    <div class="info-item"><span class="info-label">{{ _('Demografi:') }}</span> <span id="details-demographics"></span></div>
                    <div class="info-item"><span class="info-label">{{ _('Tema:') }}</span> <span id="details-themes"></span></div>
                    <div class="info-item tags full-width"><span class="info-label">{{ _('Etiketler:') }}</span> <span id="details-tags"></span></div>
                    <div class="details-notes full-width"><h3 class="info-label">{{ _('Konu') }}</h3><p id="details-synopsis"></p></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- MyAnimeList Import Modal -->
    <div id="import-mal-modal" class="modal">
        <div class="modal-content">
            <span id="close-import-modal-btn" class="close-btn">&times;</span>
            <h2>{{ _('MyAnimeList Listesini İçe Aktar') }}</h2>
            <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">
                {{ _('MyAnimeList\'ten export ettiğiniz XML dosyasını yükleyin. Mevcut listenizle birleştirilecektir.') }}
            </p>
            
            <form id="import-mal-form" enctype="multipart/form-data">
                <div class="form-group">
                    <label for="mal-file">{{ _('XML Dosyası:') }}</label>
                    <input type="file" id="mal-file" name="mal_file" accept=".xml" required>
                    <small style="color: var(--text-secondary);">
                        {{ _('Sadece MyAnimeList export XML dosyaları desteklenir.') }}
                    </small>
                </div>
                
                <div class="form-group">
                    <label>{{ _('İçe Aktar Seçenekleri:') }}</label>
                    <div class="checkbox-group">
                        <label class="checkbox-item">
                            <input type="checkbox" id="import-scores" name="import_scores" checked>
                            <span>{{ _('Kullanıcı puanlarını içe aktar') }}</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="import-notes" name="import_notes" checked>
                            <span>{{ _('Kullanıcı notlarını içe aktar') }}</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="import-dates" name="import_dates" checked>
                            <span>{{ _('İzleme tarihlerini içe aktar') }}</span>
                        </label>
                    </div>
                </div>
                
                <div class="modal-actions">
                    <button type="button" id="cancel-import-btn" class="btn btn-secondary">{{ _('İptal') }}</button>
                    <button type="submit" id="submit-import-btn" class="btn btn-primary">
                        {{ _('İçe Aktar') }}
                    </button>
                </div>
            </form>
            
            <div id="import-progress" style="display: none;">
                <div class="progress-info">
                    <div class="progress-bar">
                        <div class="progress" id="import-progress-bar"></div>
                    </div>
                    <p id="import-status-text">{{ _('İçe aktarım başlatılıyor...') }}</p>
                    <div class="progress-details">
                        <small style="color: var(--text-secondary);">
                            {{ _('Bu işlem, veritabanında olmayan anime/manga\'lar için Jikan API\'den veri çekecektir.') }}
                            <br>{{ _('Lütfen bekleyiniz, bu biraz zaman alabilir...') }}
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}
{% block scripts %}
    <script>
        const translations = {
            progress_label: "{{ _('Bölüm:') }}",
            select_all: "{{ _('Tümünü Seç') }}",
            clear_selection: "{{ _('Seçimi Kaldır') }}",
            delete_selected: "{{ _('Seçilenleri Sil') }}",
            selected: "{{ _('Seçilen') }}",
            entries_will_be_deleted: "{{ _('kayıt kalıcı olarak silinecek. Bu işlem geri alınamaz. Devam etmek istiyor musunuz?') }}"
        };
    </script>
    <script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
{% endblock %}